---
title: "[SLAM][Algorithm] Iterative Closest Point"
date: 2025-04-08 17:17:00 +0900
categories: SLAM
use_math: true
---

<br>

## 1. Iterative Closest Point

<br>

Iterative Closest Point (ICP)는 포인트 클라우드 정합 알고리즘(point cloud registration algorithm)으로, 2D 라이다 기반으로 위치 정보를 업데이트할 때 (to align the newest LiDAR scan with the previous scan) 사용된다. 두 포인트 클라우드 사이의 차이를 최소화해서 로봇의 localization을 수행하거나 path planning을 최적화한다 [1].

<br>

![ICP idea](/assets/img/2025-04-08/icp-idea.png)

<br>

ICP 알고리즘은 세 단계로 구성된다.

<br>

### 1.1 Association

<br>

Association은 두 포인트 클라우드 사이의 연관성을 구축하는 과정이다. 한 포인트 클라우드 내의 임의의 포인트를 다른 포인트 클라우드에서 그것과 가장 가까운 포인트에 매칭하는 것이다. 보통 유클리드 거리(Euclidean distance)가 가장 짧은 포인트끼리 매칭한다.

<br>

예를 들어, 포인트 r1과 가장 가까운 포인트는 포인트 b1, 포인트 r2와 가장 가까운 포인트는 포인트 b2, ... 로 아래의 그림과 같이 두 포인트 클라우드 사이의 연관성을 구축할 수 있다.

<br>

![ICP example](/assets/img/2025-04-08/icp-example.png)

<br>

### 1.2 Transformation

<br>

Transformation은 association 단계에서 매칭된 포인트들 사이의 최적의 기하학적 변환을 찾는 과정이다. 두 포인트 클라우드를 정합하기 위한 rotation과 transformation을 추정한다. 주로 최소제곱법(Method of Least Squares)로 평균 제곱 오차를 최소화하여 matrix를 계산한다. (여기서부터 다시!!!!! 굿모닝 :D)

<br>

### 1.3 Error Evaluation

<br> Error Evalauation은 transformation 단계에서 추정한 변환을 적용한 뒤 두 포인트 클라우드 간 일치도를 평가하는 과정이다. 거리의 제곱의 합으로 계산을 해서 오류를 계산하게 된다. 그리고 그 오류를 최소화 하는 방향으로 알고리즘을 반복적으로 수행한다.

<br>

하지만 센서 노이즈 등 여러 요인들에 의해서 에러가 0이 될 수는 없고. 그렇기 때문에 오차가 어떤 특정 임계값 이하로 줄어들거나. 아니면 오차가 안 줄더라도 반복 횟수의 최대치에 도달하게 되면 알고리즘은 종료된다. 아래 그림은 ICP 알고리즘의 반복 횟수를 25회로 제한하고 두 포인트 클라우드가 정합되는 과정을 보여준다 [2].

<br>

![ICP example](/assets/img/2025-04-08/icp-example-monkey.gif)

<br>

그래서 ICP 알고리즘의 입력은 source 포인트 클라우드와 target 포인트 클라우드. 그리고 초기 추정치도 넣어줄 수 있다. 출력은 두 포인트 클라우드를 붙이기 위한. 최적의 변환 행렬(transformation matrix)와 최종적으로 나왔던 이 정합 오차(registration error)가 출력으로 나오게 된다 [3].

<br>

## 2. Demonstration of the ICP Process

<br>

IRL 데이터셋을 예로 들어, ICP 과정을 살펴본다.

<br>

1) Two scans we wish to align using ICP

![ICP process 1](/assets/img/2025-04-08/icp-process-1.png)

두 개의 연속된 레이저 스캔이 있다. Target인 이전 스캔은 청록색(cyan)으로, source라고 하는 새로운 스캔은 자홍색(magenta)으로 표시되었다. 목표는 source를 target에 가장 잘 정렬하는 고정 변환(회전 및 평행 이동)을 찾는 것이다.

변환은 파란색 포인트 클라우드가 target 포인트 클라우드라고 하면 보통 빨간색 포인트 클라우드를 변환하고자 하는 source 포인트 클라우드라고 한다. 

<br>

2) The association step

![ICP process 2](/assets/img/2025-04-08/icp-process-2.png)

첫 번째 단계는 source 스캔의 어느 점이 target 스캔의 점과 동일한 물리적 특징에 해당하는지 결정하는 것이다. 이를 수행하기 위한 가장 간단한 방법은 가장 가까운 이웃 검색(a nearest neighbor search)이다. source 스캔의 점은 target 스캔의 가장 가까운 점과 연결된다. 가장 가까운 점들의 연관성(associations)은 파란색으로 표시되었다.

가까운 이웃 검색에서 몇 가지 실수를 확인할 수 있지만, 일반적으로 표시된 연관성은 올바른 방향으로 source 포인트를 끌어온다.


각각의 이제 포인트 클라우드들이 어떻게 연결하면 좋은지. 제일 가까운 점들을 이런 식으로 찾는다. 기하학적인 association을 찾는다. 보통은 Euclidean 거리로 찾는다.



<br>

3) The transformation step

![ICP process 3](/assets/img/2025-04-08/icp-process-3.png)

다음 단계는 변환이다. source 점에 적용할 때 연관된 점 사이의 평균 제곱 거리를 최소화 하는 변환을 찾는다.

<br>

$$
\tilde{T}=\underset{T}{\text{argmin}}\frac{1}{N}\sum_i^N \|t_i - Ts_i\|^2
$$

<br>

여기서 $\tilde{T}$는 최종으로 추정된 변환(the final estimated transform)이고, $t_i$와 $s_i$는 각각 target points와 source points이다.



<br>

4) Nearest neighbor associations for the transformed source points

![ICP process 4](/assets/img/2025-04-08/icp-process-4.png)

$$
e=\frac{1}{N}\sum_i^N \|t_i - Ts_i\|^2
$$

오차를 평가하고 위 과정을 더 반복할 것인지 결정한다. 예시에서는 스캔이 여전히 잘 정렬되지 않았으므로 위 과정을 더 반복한다.

<br>

5) Scan alignment after the fifth iteration

![ICP process 5](/assets/img/2025-04-08/icp-process-5.png)

5번의 반복(iteration)을 거친 뒤 꽤 만족스러운 정렬을 찾은 것을 확인할 수 있다.



붙이면 최종적으로 이런 식으로 조금 남아있긴 하다. 완전히 정합된 건 아니지만. 그나만 제일 잘 붙은 게. 이제 더 이상 해봤는데 오차가 더 이상 줄지 않는다. 이게 최선이다 라고하면은 알고리즘이 멈추겠죠. 또는 아까처럼 반복 횟수의 최대 값을 정해놓고. 그것보다 더 돌면 시간이 너무 오래 걸리니까. 마무리를 짓게 됩니다. 이렇게 하면 결국에 애를 얘로 붙이기 위한 트랜스포 메이션. 그 매트릭스를 얻을 수 있다.

<br>

![Simple 2D LiDAR odometry using ICP](/assets/img/2025-04-08/simple-2d-lidar-odometry.gif)

<br>

이것들을 바탕으로 2D 라이다 오도메트리도 계산할 수 있다. 중간에 나왔던 트랜스포메이션 매트릭스를 계속 누적게 되면 검정색으로 표시되는 트라젝토리도. 이동 궤적도 얻을 수 있다. 이건 단순하게 휠 오도메트리 없이 2D 라이다만을 바탕으로 해서 오도메트리를 계산한 것이다. 그래서 보면 사실 계속 뒤틀린다. 
그래서 이 2D 라이다 단독으로 오도메트리를 사용하면은 대략적인 궤적은 얻을 수 있지만. 정확히 얻기는 사실 쉽지 않다.

전반적으로 ICP 알고리즘이라고 하는 거는. 연속적인 레이저 스캔을 반복적으로 정렬해가면서. 스캔 간의 차이를 요 두 개 스캔 간의 차이를 최소화 함으로써. 더 정확한 주행 거리를 추정할 수 있다. 그리고 특히나 기하학적 특징이 충분한 환경에 적합하다. 특징이 명확한 환경에서 매칭이 잘 되고. 기하학적 특징이 충분한 환경에 적합하고. 스캔 간의 노이즈. 그 다음에 부분적인 중첨이 있는 경우라고 하더라도 휠 오도메트리나 IMU랑 같이 결합해서 사용하면 더 정확한 오도메트리를 제공할 수 있다. 

<br>

---

## References
[1] <https://en.wikipedia.org/wiki/Iterative_closest_point>  
[2] <https://alida.tistory.com/105>  
[3] <https://github.com/yassram/iterative-closest-point>  
[4] <https://andrewjkramer.net/lidar-odometry-with-icp/>  
[5] <https://github.com/93won/2D_LiDAR_Odom_ICP>

&nbsp;